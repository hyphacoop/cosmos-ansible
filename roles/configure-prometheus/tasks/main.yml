# Existing scrape target configuration (centralized)
# CHAIN NODES
- name: "Create Prometheus target files for chain nodes"

  template:
    src: prometheus.json.j2
    dest: "/opt/prometheus/hosts/{{ item }}.json"
    mode: 0644
    owner: prometheus
    group: prometheus
  loop: "{{ groups['node'] | default([]) }}"
  run_once: true
  tags:
    - prometheus
    - monitoring

# SYSTEM NODES
- name: Create systems directory

  file:
    path: /opt/prometheus/systems
    state: directory
    owner: prometheus
    group: prometheus
    mode: 0755
  run_once: true
  tags:
    - prometheus
    - monitoring

- name: "Create Prometheus target files for system nodes"

  template:
    src: prometheus-system.json.j2
    dest: "/opt/prometheus/systems/{{ item }}.json"
    mode: 0644
    owner: prometheus
    group: prometheus
  loop: "{{ groups['system'] | default([]) }}"
  run_once: true
  tags:
    - prometheus
    - monitoring

- name: Cleanup stale targets
  include_tasks: cleanup.yml


- name: "Create Blackbox target files for nodes"

  template:
    src: blackbox.json.j2
    dest: "/opt/prometheus/blackbox-icmp/{{ item }}.json"
    mode: 0644
    owner: prometheus
    group: prometheus
  loop: "{{ groups['node'] | default([]) }}"
  run_once: true
  tags:
    - prometheus
    - monitoring

# Prometheus configuration (run once)
- name: Deploy prometheus.yml configuration

  template:
    src: prometheus.yml.j2
    dest: /opt/prometheus/prometheus.yml
    owner: prometheus
    group: prometheus
    mode: 0644
    backup: yes
  run_once: true
  notify: reload prometheus
  tags:
    - prometheus
    - monitoring

# HTTPS exporters configuration
- name: Create HTTPS exporters directory

  file:
    path: /opt/prometheus/https-exporters
    state: directory
    owner: prometheus
    group: prometheus
    mode: 0755
  run_once: true
  tags:
    - prometheus
    - monitoring

- name: Deploy HTTPS exporter targets

  template:
    src: https-exporter.json.j2
    dest: "/opt/prometheus/https-exporters/{{ item.name }}.json"
    owner: prometheus
    group: prometheus
    mode: 0644
  loop: "{{ prometheus_https_exporters | default([]) }}"
  when: prometheus_https_exporters is defined
  run_once: true
  notify: reload prometheus
  tags:
    - prometheus
    - monitoring

# Alert rules deployment (run once per playbook execution)
- name: Create alert rules directory

  file:
    path: /opt/alertmanager/rules
    state: directory
    owner: prometheus
    group: prometheus
    mode: 0755
  run_once: true
  tags:
    - alerting
    - monitoring

- name: Deploy shared alert rules

  copy:
    src: "alert-rules/{{ item }}"
    dest: "/opt/alertmanager/rules/{{ item }}"
    owner: prometheus
    group: prometheus
    mode: 0644
  loop:
    - chain-health.yml
    - relayer-health.yml
    - host-os.yml
    - blackbox.yml
    - prometheus-selfcheck.yml
  notify: reload prometheus
  run_once: true
  tags:
    - alerting
    - monitoring

# Alertmanager fragment-based configuration
- name: Create alertmanager fragments directory

  file:
    path: /opt/alertmanager/fragments
    state: directory
    owner: prometheus
    group: prometheus
    mode: 0755
  run_once: true
  tags:
    - alerting
    - monitoring

- name: Deploy alertmanager base fragment templates

  template:
    src: "alertmanager-fragments/{{ item }}"
    dest: "/opt/alertmanager/fragments/{{ item | regex_replace('\\.j2$', '') }}"
    owner: prometheus
    group: prometheus
    mode: 0644
  loop:
    - 00-header.yml.j2
    - 10-routes-base.yml.j2
    - 20-receivers-base.yml.j2
    - 30-inhibit.yml.j2
  run_once: true
  notify: assemble alertmanager config
  tags:
    - alerting
    - monitoring

- name: Deploy alertmanager environment-specific fragment templates

  template:
    src: "alertmanager-fragments/{{ item.0 }}"
    dest: "/opt/alertmanager/fragments/{{ item.0 | regex_replace('\\.j2$', '') | regex_replace('-env', '-' + item.1.name) }}"
    owner: prometheus
    group: prometheus
    mode: 0644
  loop: "{{ ['15-routes-env.yml.j2', '25-receivers-env.yml.j2'] | product(alertmanager_chains) | list }}"
  run_once: true
  notify: assemble alertmanager config
  tags:
    - alerting
    - monitoring

- name: Assemble alertmanager.yml from fragments

  assemble:
    src: /opt/alertmanager/fragments
    dest: /opt/alertmanager/alertmanager.yml
    regexp: '\.yml$'
    owner: prometheus
    group: prometheus
    mode: 0644
  run_once: true
  notify: reload alertmanager
  tags:
    - alerting
    - monitoring
