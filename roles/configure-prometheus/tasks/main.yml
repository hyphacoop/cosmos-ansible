---
# Existing scrape target configuration (per-node)
- name: Copy over Prometheus configuration
  template:
    src: prometheus.json.j2
    dest: /opt/prometheus/hosts/{{ inventory_hostname }}.json
    mode: 0644
    owner: prometheus
    group: prometheus

- name: Copy over Blackbox Exporter configuration
  template:
    src: blackbox.json.j2
    dest: /opt/prometheus/blackbox-icmp/{{ inventory_hostname }}.json
    mode: 0644
    owner: prometheus
    group: prometheus

# Alert rules deployment (run once per playbook execution)
- name: Create alert rules directory
  delegate_to: "{{ grafana_ssh_url }}"
  file:
    path: /opt/alertmanager/rules
    state: directory
    owner: prometheus
    group: prometheus
    mode: 0755
  run_once: true
  tags:
    - alerting
    - monitoring

- name: Deploy shared alert rules
  delegate_to: "{{ grafana_ssh_url }}"
  copy:
    src: "alert-rules/{{ item }}"
    dest: "/opt/alertmanager/rules/{{ item }}"
    owner: prometheus
    group: prometheus
    mode: 0644
  loop:
    - chain-health.yml
    - relayer-health.yml
    - host-os.yml
    - blackbox.yml
    - prometheus-selfcheck.yml
  notify: reload prometheus
  run_once: true
  tags:
    - alerting
    - monitoring

# Alertmanager fragment-based configuration
- name: Create alertmanager fragments directory
  delegate_to: "{{ grafana_ssh_url }}"
  file:
    path: /opt/alertmanager/fragments
    state: directory
    owner: prometheus
    group: prometheus
    mode: 0755
  run_once: true
  tags:
    - alerting
    - monitoring

- name: Deploy alertmanager base fragment templates
  delegate_to: "{{ grafana_ssh_url }}"
  template:
    src: "alertmanager-fragments/{{ item }}"
    dest: "/opt/alertmanager/fragments/{{ item | regex_replace('\\.j2$', '') }}"
    owner: prometheus
    group: prometheus
    mode: 0644
  loop:
    - 00-header.yml.j2
    - 10-routes-base.yml.j2
    - 20-receivers-base.yml.j2
    - 30-inhibit.yml.j2
  run_once: true
  notify: assemble alertmanager config
  tags:
    - alerting
    - monitoring

- name: Deploy alertmanager environment-specific fragment templates
  delegate_to: "{{ grafana_ssh_url }}"
  template:
    src: "alertmanager-fragments/{{ item }}"
    dest: "/opt/alertmanager/fragments/{{ item | regex_replace('\\.j2$', '') | regex_replace('-env', '-' + chain_id) }}"
    owner: prometheus
    group: prometheus
    mode: 0644
  loop:
    - 15-routes-env.yml.j2
    - 25-receivers-env.yml.j2
  run_once: true
  notify: assemble alertmanager config
  tags:
    - alerting
    - monitoring

- name: Assemble alertmanager.yml from fragments
  delegate_to: "{{ grafana_ssh_url }}"
  assemble:
    src: /opt/alertmanager/fragments
    dest: /opt/alertmanager/alertmanager.yml
    regexp: '\.yml$'
    owner: prometheus
    group: prometheus
    mode: 0644
  run_once: true
  notify: reload alertmanager
  tags:
    - alerting
    - monitoring
