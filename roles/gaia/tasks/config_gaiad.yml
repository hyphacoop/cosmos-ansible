---
# Config file generation
- name: copy app.toml
  when: app_toml_file is defined
  copy:
    src: '{{app_toml_file}}'
    dest: '{{gaiad_home}}/config/app.toml'
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'

- name: Get home directory of Ansible runner
  shell: "echo $HOME"
  register: ansible_runner_home

- name: create SSH keypair for multi node sync
  when: start_multinode
  community.crypto.openssh_keypair:
    path: "{{ ansible_runner_home.stdout }}/.ssh/id_rsa"
    type: rsa
    comment: "{{ inventory_hostname }}"
  delegate_to: "{{ main_node }}"

- name: store SSH pupkey in variable
  when: start_multinode
  shell: "cat {{ ansible_runner_home.stdout }}/.ssh/id_rsa.pub"
  register: ssh_pub_key
  delegate_to: "{{ main_node }}"

- name: add generated SSH key to multi nodes
  when: start_multinode
  authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ ssh_pub_key.stdout }}"

- name: copy app.toml to multi-node gaia home
  when: start_multinode and app_toml_file is defined
  copy:
    src: '{{ app_toml_file }}'
    dest: '{{ gaiad_user_home }}/multinode/{{ inventory_hostname }}/config/app.toml'
    owner: '{{ gaiad_user }}'
    group: '{{ gaiad_user }}'
  delegate_to: "{{ main_node }}"

- name: copy config.toml
  when: config_toml_file is defined
  copy:
    src: '{{config_toml_file}}'
    dest: '{{gaiad_home}}/config/config.toml'
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'

- name: copy config.toml to muti-node gaia home
  when: start_multinode and config_toml_file is defined
  copy:
    src: '{{ config_toml_file }}'
    dest: '{{ gaiad_user_home }}/multinode/{{ inventory_hostname }}/config/config.toml'
    owner: '{{ gaiad_user }}'
    group: '{{ gaiad_user }}'
  delegate_to: "{{ main_node }}"

- name: copy node_key.json
  when: node_key_file is defined
  copy:
    src: '{{node_key_file}}'
    dest: '{{gaiad_home}}/config/node_key.json'
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'

- name: copy node_key.json to muti-node gaia home
  when: start_multinode and node_key_file is defined
  copy:
    src: '{{ node_key_file }}'
    dest: '{{ gaiad_user_home }}/multinode/{{ inventory_hostname }}/config/node_key.json'
    owner: '{{ gaiad_user }}'
    group: '{{ gaiad_user }}'
  delegate_to: "{{ main_node }}"

- name: copy priv_validator_key.json
  when: priv_validator_key_file is defined
  copy:
    src: '{{priv_validator_key_file}}'
    dest: '{{gaiad_home}}/config/priv_validator_key.json'
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'

- name: copy priv_validator_key.json to muti-node gaia home
  when: start_multinode and priv_validator_key_file is defined
  copy:
    src: '{{ priv_validator_key_file }}'
    dest: '{{ gaiad_user_home }}/multinode/{{ inventory_hostname }}/config/priv_validator_key.json'
    owner: '{{ gaiad_user }}'
    group: '{{ gaiad_user }}'
  delegate_to: "{{ main_node }}"

# Create validator
- name: create validator
  when: gaiad_create_validator
  shell: |
    cd $HOME
    PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    gaiad keys add validator --keyring-backend {{gaiad_validator_keyring}} --home {{gaiad_home}} --output json
    gaiad add-genesis-account validator {{gaiad_validator_coins}} --home {{gaiad_home}} --keyring-backend="{{gaiad_validator_keyring}}"
  register: gaiad_create_validator_output
  become_user: "{{gaiad_user}}"

- name: save validator name, address, and mnemonic
  when: gaiad_create_validator
  copy:
    content="{{gaiad_create_validator_output.stderr}}"
    dest="{{gaiad_home}}/validator.json"
  become_user: "{{gaiad_user}}"

- name: create genesis accounts
  when: gaiad_airdrop and gaiad_create_validator
  shell: |
    cd $HOME
    PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    gaiad add-genesis-account {{ item }} {{gaiad_airdrop_coins}} --home {{gaiad_home}}
  become_user: "{{gaiad_user}}"
  loop: "{{ gaiad_airdrop_accounts }}"

- name: create validator
  when: gaiad_create_validator
  shell: |
    cd $HOME
    PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    gaiad gentx validator {{gaiad_gentx_validator_stake}} --keyring-backend="{{gaiad_validator_keyring}}" --home {{gaiad_home}} --chain-id {{chain_id}}
  become_user: "{{gaiad_user}}"

- name: create multi-node self-delegation accounts save the mnemonics shown in the output
  when: start_multinode
  shell: |
    cd $HOME
    PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    gaiad keys add {{ inventory_hostname }} --keyring-backend {{ gaiad_validator_keyring }} --home {{gaiad_home}} --output json
    gaiad add-genesis-account {{ inventory_hostname }} 1{{ gaiad_gentx_validator_stake }} --home {{gaiad_home}} --keyring-backend="{{ gaiad_validator_keyring }}"
  register: gaiad_create_multinode_validator_output
  become_user: "{{ gaiad_user }}"
  delegate_to: "{{ main_node }}"
  throttle: 1

- name: save multi-node validator name, address, and mnemonic
  when: start_multinode
  copy:
    content="{{gaiad_create_multinode_validator_output.stderr}}"
    dest="{{ gaiad_user_home }}/multinode/{{ inventory_hostname }}/validator.json"
  delegate_to: "{{ main_node }}"
  become_user: "{{ gaiad_user }}"

- name: store multi node IDs
  when: start_multinode
  shell: |
    cd $HOME
    PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    gaiad tendermint show-node-id --home {{ gaiad_user_home }}/multinode/{{ inventory_hostname }}
  register: gaiad_multinode_id
  become_user: "{{ gaiad_user }}"
  delegate_to: "{{ main_node }}"

- name: print muti node IDs
  when: start_multinode
  debug:
    msg: 'Node ID for {{ inventory_hostname }} is {{ gaiad_multinode_id.stdout }}'
  become_user: "{{gaiad_user}}"

- name: create multi-node validators
  when: start_multinode
  shell: |
    cd $HOME
    PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    gaiad gentx {{ inventory_hostname }} {{ gaiad_gentx_validator_stake }} --keyring-backend="{{ gaiad_validator_keyring }}" --home {{ gaiad_home }} --chain-id {{ chain_id }} --node-id {{ gaiad_multinode_id.stdout }} --moniker {{ inventory_hostname }} --output-document {{ gaiad_home }}/config/gentx/{{ inventory_hostname }}.json
  become_user: "{{ gaiad_user }}"
  delegate_to: "{{ main_node }}"
  throttle: 1

- name: collect gentx
  when: gaiad_create_validator
  shell: |
    cd $HOME
    PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    gaiad collect-gentxs --home {{gaiad_home}}
  become_user: "{{gaiad_user}}"

# - name: Transfer multi-node gaia homes to their machines
#   when: start_multinode
#   synchronize:
#     mode: push
#     src: "{{ gaiad_user_home }}/multinode/{{ inventory_hostname }}/"
#     dest: "{{ gaiad_home }}"
#     delete: yes
#     recursive: yes
#     rsync_opts:
#       - "--chown={{ gaiad_user }}:{{ gaiad_user }}"
#   delegate_to: "{{ main_node }}"

- name: Transfer multi-node config/genesis.json
  when: start_multinode
  synchronize:
    mode: push
    src: "{{ gaiad_home }}/config/genesis.json"
    dest: "{{ gaiad_home }}/config/genesis.json"
    delete: yes
    rsync_opts:
      - "--chown={{ gaiad_user }}:{{ gaiad_user }}"
  delegate_to: "{{ main_node }}"

- name: Transfer multi-node config/node_key.json
  when: start_multinode
  synchronize:
    mode: push
    src: "{{ gaiad_home }}/config/node_key.json"
    dest: "{{ gaiad_home }}/config/node_key.json"
    delete: yes
    rsync_opts:
      - "--chown={{ gaiad_user }}:{{ gaiad_user }}"
  delegate_to: "{{ main_node }}"

- name: Transfer multi-node config/priv_validator_key.json
  when: start_multinode
  synchronize:
    mode: push
    src: "{{ gaiad_home }}/config/priv_validator_key.json"
    dest: "{{ gaiad_home }}/config/priv_validator_key.json"
    delete: yes
    rsync_opts:
      - "--chown={{ gaiad_user }}:{{ gaiad_user }}"
  delegate_to: "{{ main_node }}"

- name: patch genesis file with minimum deposit and short voting period
  when: gaiad_gov_testing
  shell: |
    cd {{gaiad_home}}/config
    jq '.app_state.gov.deposit_params.min_deposit[0].amount |= "1"' genesis.json > temp.json
    jq '.app_state.gov.voting_params.voting_period |= "{{ gaiad_voting_period }}"' temp.json > genesis.json
    rm temp.json

- name: patch genesis file with specified denom
  replace:
    path: '{{gaiad_home}}/config/genesis.json'
    regexp: 'stake'
    replace: '{{gaiad_bond_denom}}'

# Get trust height automatically
- name: obtain trust height
  when: statesync_enabled and statesync_auto_populate
  script:
    get_trust_height.sh {{ statesync_rpc_servers.split(',')[0] }}
  register: trust_height

- name: obtain trust height block hash ID
  when: statesync_enabled and statesync_auto_populate
  script:
    get_trust_hash.sh {{ statesync_rpc_servers.split(',')[0] }} {{ trust_height.stdout }}
  register: trust_hash

- name: print trust height and hash ID
  when: statesync_enabled and statesync_auto_populate
  debug:
    msg: 'Height {{trust_height.stdout }} has hash ID {{ trust_hash.stdout }}'
  become_user: "{{gaiad_user}}"

- name: set state sync variables
  when: statesync_enabled and statesync_auto_populate
  set_fact:
    statesync_trust_height: "{{ trust_height.stdout }}"
    statesync_trust_hash: "{{ trust_hash.stdout }}"

## Addressbook config
- name: copy addrbook.json
  when: addrbook_file is defined
  copy:
    src: '{{addrbook_file}}'
    dest: '{{gaiad_home}}/config/addrbook_file.json'
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'

- name: download addrbook.json from URL
  when: addrbook_url is defined
  get_url:
    url: "{{addrbook_url}}"
    dest: "{{gaiad_home}}/config/addrbook.json"
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'

## Patching Config files
- name: generate config json for patching toml files
  template:
    src: ansible_vars.json.j2
    dest: '{{gaiad_home}}/config/ansible_vars.json'
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'

- name: patch .toml configs with ansible variables
  script: |
    copy_config_vars.py --gaiad_home=$(echo {{gaiad_home}}) \
      --config_file=$(echo {{gaiad_home}}/config/ansible_vars.json)
  become_user: "{{gaiad_user}}"

- name: delete generated config json
  file:
    state: absent
    path: '{{gaiad_home}}/config/ansible_vars.json'
    owner: '{{gaiad_user}}'
    group: '{{gaiad_user}}'
