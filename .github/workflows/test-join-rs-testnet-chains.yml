name: Join RS Testnets
on:
  workflow_dispatch:
  schedule:
    # At 15:30 on Monday.
    - cron: '30 15 * * 1'
  push:
    paths-ignore:
      - 'docs/**'
      - 'examples/**'
      - 'logs/**'
      - '!examples/inventory-local.yml'
      - 'README.md'

jobs:
  rs-testnet-provider:
    runs-on: self-hosted-debian-11
    steps:
      # Get system info
      - run: ifconfig
      - run: lscpu
      - run: df -h
      - run: free -m
      - run: uname -a
      - run: lsb_release -a
      - run: echo "GitHub branch is ${{ github.ref }}"
      - run: whoami
      - run: pwd

      - name: Update apt
        run: sudo apt update

      - name: Install required packages
        run: sudo apt -y install python-is-python3 python3-distutils screen

      - name: Install pip
        run: |
          wget https://bootstrap.pypa.io/get-pip.py -O /tmp/get-pip.py
          sudo python /tmp/get-pip.py

      - name: Update path
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Create artifact directory
        run: |
          mkdir artifact

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install ansible toml

      - name: Configure ansible.cfg
        run: echo "transport = local" >> ansible.cfg

      - name: Install ansible-galaxy requirements
        run: ansible-galaxy install -r requirements.yml

      - name: Run playbook
        run: ansible-playbook node.yml -i examples/inventory-rs-testnet-provider.yml --extra-vars "target=local reboot=false node_user=$(whoami) enable_swap=false "

      - name: Check cosmovisor service
        run: systemctl status cosmovisor

      - name: Check blocks are being produced
        run: |
          height=$(curl -s https://rpc.provider-sentry-01.rs-testnet.polypore.xyz/block | jq -r '.result.block.header.height')
          echo "Waiting for block $[ $height + 100 ]..."
          tests/test_block_production.sh 127.0.0.1 26657 $[ $height + 100]
